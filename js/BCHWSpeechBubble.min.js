(function(a){var b=function(d,c){LayoutRectangle.call(this,d);this.bubbleArrowHeight=c;this.lineThickness=4;this.animateTimeoutId=-1;this.padding=10;this.unitAnimator=new UnitAnimator()};b.prototype=Object.create(LayoutRectangle.prototype);b.prototype.constructor=LayoutRectangle;b.OPEN_DURATION=600;b.CLOSE_DURATION=400;b.ANIMATE_INTERVAL=20;b.STAY_OPEN_INTERVAL=5000;b.prototype.showBubble=function(c,g,e,h,l,k){this.triangleX=g;this.showCompleteCallback=h?h:null;this.startRemoveBubbleCallback=l?l:null;this.removeBubbleCompleteCallback=k?k:null;this.x=c.x-this.padding;this.y=c.y-this.padding;this.width=c.width+this.padding*2;this.height=c.height+this.padding*2;var d=18;var j=9;this.cornerRadii=[];for(var f=0;f<4;f++){this.cornerRadii[f]=BCHWMathUtil.getRandomNumberInRange(j,d)}var m=this;this.unitAnimator.reset(b.OPEN_DURATION,b.ANIMATE_INTERVAL,function(){m.unitAnimatorShowUpdateHandler()},function(){m.unitAnimatorShowCompleteHandler()});this.unitAnimator.start(UnitAnimator.easeOutSine)};b.prototype.unitAnimatorShowUpdateHandler=function(){this.renderBubble(BCHWMathUtil.interpolate(this.unitAnimator.getAnimationPercent(),0.4,1))};b.prototype.unitAnimatorShowCompleteHandler=function(){this.renderBubble(1);if(this.showCompleteCallback){this.showCompleteCallback();this.showCompleteCallback=null}var c=this;this.speechBubbleTimeout=setTimeout(function(){c.removeBubble()},b.STAY_OPEN_INTERVAL)};b.prototype.removeBubble=function(){if(this.startRemoveBubbleCallback){this.startRemoveBubbleCallback();this.startRemoveBubbleCallback=null}var c=this;this.unitAnimator.reset(b.CLOSE_DURATION,b.ANIMATE_INTERVAL,function(){c.unitAnimatorRemoveUpdateHandler()},function(){c.unitAnimatorRemoveCompleteHandler()});this.unitAnimator.start(UnitAnimator.easeInSine)};b.prototype.unitAnimatorRemoveUpdateHandler=function(){this.renderBubble(BCHWMathUtil.interpolate(this.unitAnimator.getAnimationPercent(),1,0.4))};b.prototype.unitAnimatorRemoveCompleteHandler=function(){this.clear();if(this.removeBubbleCompleteCallback){this.removeBubbleCompleteCallback();this.removeBubbleCompleteCallback=null}};b.prototype.renderBubble=function(e){this.clear();this.context.fillStyle="#FFFFFF";this.context.lineWidth=0;var d=new BCHWGeom.Rectangle(this.x+1,this.y+1,(this.width-2)*e,this.height-this.bubbleArrowHeight-2);this.context.beginPath();var c=this.cornerRadii[0];this.context.moveTo(d.x,d.y+c);this.context.arc(d.x+c,d.y+c,c,Math.PI,Math.PI+BCHWMathUtil.HALF_PI);c=this.cornerRadii[1];this.context.lineTo(d.getRight()-c,d.y);this.context.arc(d.getRight()-c,d.y+c,c,Math.PI+BCHWMathUtil.HALF_PI,BCHWMathUtil.PI2);c=this.cornerRadii[2];this.context.lineTo(d.getRight(),d.getBottom()-c);this.context.arc(d.getRight()-c,d.getBottom()-c,c,0,BCHWMathUtil.HALF_PI);c=this.cornerRadii[3];this.context.lineTo(d.x+c,d.getBottom());this.context.arc(d.x+c,d.getBottom()-c,c,BCHWMathUtil.HALF_PI,Math.PI);c=this.cornerRadii[0];this.context.lineTo(d.x,d.y+c);this.context.fill();this.context.closePath();if(e==1){this.context.beginPath();if(this.triangleX>this.width/2){this.context.moveTo(this.triangleX,d.getBottom()-2);this.context.lineTo(this.triangleX,this.getBottom());this.context.lineTo(this.triangleX-this.padding-Math.random()*(2*this.padding),d.getBottom()-2)}else{this.context.moveTo(this.triangleX,d.getBottom()-2);this.context.lineTo(this.triangleX,this.getBottom());this.context.lineTo(this.triangleX+this.padding+Math.random()*(2*this.padding),d.getBottom()-2)}this.context.closePath();this.context.fill()}};b.prototype.stop=function(){this.clear();this.unitAnimator.pause();clearTimeout(this.speechBubbleTimeout)};a.BCHWSpeechBubble=b}(window));